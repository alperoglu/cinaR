---
title: "Introduction to cinaR"
author: "E Onur Karakaslar"
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    fig_width: 5

vignette: >
  %\VignetteIndexEntry{cinaR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Quick Start

```{r}
library(cinaR)
data("atac_seq_consensus_bm")
```

Bed formatted consensus matrix (chr, start, end and samples)
```{r}
dim(bed)
```


```{r}
# bed formatted file
head(bed[,1:4])
```

Create the contrasts you want to compare, here we create contrasts for 
22 mice samples from different strains.
```{r}
# create contrast vector which will be compared.
contrasts<- c("B6", "B6", "B6", "B6", "B6", "NZO", "NZO", "NZO", "NZO", "NZO", "NZO", 
              "B6", "B6", "B6", "B6", "B6", "NZO", "NZO", "NZO", "NZO", "NZO", "NZO")
```

`cinaR` function directly computes the differentially accessible peaks.
```{r cache=TRUE}
# If reference genome is not set hg38 will be used!
results <- cinaR(bed, contrasts, reference.genome = "mm10")
```

Now, you can access differential accessibility (DA) and enrichment results.
```{r}
names(results)
````

Inside `DA.results`, you have the consensus peaks (cp) and differentially accessible (DA) peaks.
If batch correction was run, then `cp` will be a batch-corrected consensus matrix, otherwise it is the original one you provided.

```{r}
names(results$DA.results)
```
There are many information `cinaR` provides such as adjusted p value, 
log fold-changes, gene names etc for each peak:
```{r}
colnames(results$DA.results$DA.peaks$B6_NZO)
```


Here is an overview of those DA peaks:
```{r }
head(results$DA.results$DA.peaks$B6_NZO[,1:5])
```
> Since the comparison is `B6_NZO`, if fold-changes are positive it means they are more accesible in B6 compared to NZO and vice versa for negative values!

and here is a little overview for enrichment analyses results:
```{r}
head(results$Enrichment.Results$B6_NZO[,c("module.name","overlapping.genes", "adj.p")])
```
You can easily get the PCA plots of the samples:
```{r dpi=300}
pca_plot(results, contrasts, show.names = F)
```

You can overlay different information onto PCA plots as well!
```{r}
# Overlaid information
overlaid.info <- c("B6-18mo", "B6-18mo", "B6-18mo", "B6-18mo", "B6-18mo", 
                   "NZO-18mo", "NZO-18mo", "NZO-18mo", "NZO-18mo", "NZO-18mo", "NZO-18mo", 
                   "B6-3mo", "B6-3mo", "B6-3mo", "B6-3mo", "B6-3mo", 
                   "NZO-3mo", "NZO-3mo", "NZO-3mo", "NZO-3mo", "NZO-3mo", "NZO-3mo")
# Sample IDs
sample.names <- c("GT18-01783", "GT18-01780", "GT18-01781", "GT18-01778", "GT18-01779", 
"GT18-03804", "GT18-03805", "GT18-03806", "GT18-03807", "GT18-03808", 
"GT18-03809", "GT18-04678", "GT18-04679", "GT18-04680", "GT18-04681", 
"GT18-04682", "GT18-10918", "GT18-10916", "GT18-10919", "GT18-10921", 
"GT18-10917", "GT18-10920")
```
```{r dpi=300}
pca_plot(results, overlaid.info, sample.names)
```


You can plot your enrichment results using:
```{r dpi=300}
dot_plot(results)
```

if it gets too crowded, you can get rid of the irrelevant pathways as well:
```{r dpi=300}
dot_plot(results, filter.pathways = T)
```


## Creating different contrasts

Note that you can further divide the resolution of contrasts, for instance this
is also a valid vector
```{r}
contrasts <- sapply(strsplit(colnames(bed), split = "-", fixed = T), 
                    function(x){paste(x[1:4], collapse = "-")})[4:25]
unique(contrasts)
```
in this case, each of them will be compared to each other which will result in
28 different comparisons.

## Running enrichment with different dataset
You can run the enrichment analyses with a custom geneset:
```{r eval=FALSE}
cinaR(..., geneset = new_geneset)
```

`geneset` must be a `.gmt` formatted symbol file. You can download different genesets from this [site](https://www.gsea-msigdb.org/gsea/downloads.jsp). 

> You can use `read.gmt` function from `qusage` package to read genesets into your current environment.

Also, you can familarize yourself with the format by checking out :
```{r eval=FALSE}
# default geneset to be used
data("VP2008")
```


## Selecting different reference genomes
For now, `cinaR` supports 3 genomes for human and mice models:

- `hg38`
- `hg19`
- `mm10`

You can set your it using `reference.genome` argument.

## Batch Effect Correction
If you suspect your data have unknown batch effects, you can use:
```{r eval=FALSE}
cinaR(..., batch.correction = T)
```
This option will run [Surrogate Variable Analysis](http://bioconductor.org/packages/release/bioc/html/sva.html) (SVA) and try to
adjust your data for unknown batch effects. If however, you already know the batches of the samples, you can simply set the `batch.information` argument as well:

```{r eval=FALSE}
# batch information should be number a vector where
# the length of it equals to the number of samples.
cinaR(..., batch.correction = T, batch.information = c(rep(0, 11), rep(1,11)))
```
> Reminder - In our example data we have 22 samples
  
## Saving DA peaks to excel

Setting `save.DA.peaks = TRUE` in `cinaR` function will create a `DApeaks.xlsx` file
in the current directory. This file includes all the comparisons in different tabs.
Additionally, you can set the path/name of the file using 
`DA.peaks.path` argument after setting `save.DA.peaks = TRUE`.

For instance, 

```{r eval=FALSE}
results <- cinaR(..., save.DA.peaks = T, DA.peaks.path = "./Peaks_mice.xlsx")
```

will create an excel file with name `Peaks_mice.xlsx` in the current directory.

## Using different GLM algorithms
Currently, `cinaR` supports 4 different algorithms, namely; 

- edgeR
- limma-voom
- limma-trend
- DESeq2

If not set, it uses `edgeR` for differential analyses. 
You can change the used algorithm by simply setting `DA.choice` argument.
For more information, `?cinaR`

## Some useful arguments
```{r eval=FALSE}
# new FDR threshold for DA peaks
results <- cinaR(..., DA.fdr.threshold = 0.1)

# filters out pathways
results <- cinaR(..., enrichment.FDR.cutoff = 0.1)

# does not run enrichment pipeline
results <- cinaR(..., run.enrichment = FALSE)

# creates the piechart from chIpSeeker package
results <- cinaR(..., show.annotation.pie = TRUE)

# change cut-off value for dot plots
dot_plot(..., fdr.cutoff = 0.05)
```

## Contribution

You can send pull requests to make your contributions.

I occasionally mess up, so all comments are appreciated!

## Future work
1. ~~Add enrichment pipeline~~
  + ~~hyper-geometric p-value~~
  + ~~geneset enrichment analyses~~
  + ~~make it compitable with `.gmt` format~~

2. Visualization of Enrichment Results
  + ~~Dot plot~~
  + Network plot

3. Small improvements
  + save enrichment files to excel
  + ~~make SV number an argument~~
  + pass `...` into several functions


## Author

- [E Onur Karakaslar](https://eonurk.github.io)

## License

- GNU General Public License v3.0

## References

- Robinson MD, McCarthy DJ, Smyth GK (2010). “edgeR: a Bioconductor package for differential expression analysis of digital gene expression data.” Bioinformatics, 26(1), 139-140. doi: 10.1093/bioinformatics/btp616.

- Ritchie ME, Phipson B, Wu D, Hu Y, Law CW, Shi W, Smyth GK (2015). “limma powers differential expression analyses for RNA-sequencing and microarray studies.” Nucleic Acids Research, 43(7), e47.
- Love, M.I., Huber, W., Anders, S. (2014) Moderated estimation of fold change and dispersion for RNA-seq data with DESeq2. Genome Biology, 15:550. 10.1186/s13059-014-0550-8
